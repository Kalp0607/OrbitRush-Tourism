<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Create New Tour | Admin</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f5f6fa;
        color: #333;
      }
      /* Available Dates Section */
      .dates-section {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background: #f8f9fa;
      }

      .dates-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .dates-header h3 {
        margin: 0;
        color: #2c3e50;
        font-size: 1.2rem;
      }

      .add-date-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 0.6rem 1.2rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .add-date-btn:hover {
        background: #2980b9;
      }

      .date-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 0.8rem;
        padding: 0.8rem;
        background: white;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      .date-item input[type="date"] {
        flex: 1;
        margin: 0;
      }

      .remove-date-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 0.5rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8rem;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .remove-date-btn:hover {
        background: #c0392b;
      }

      .dates-info {
        background: #e8f4f8;
        padding: 1rem;
        border-radius: 6px;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #0c5460;
      }

      .date-count {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
      }

      .header {
        background: #2c3e50;
        color: white;
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .back-btn {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .container {
        max-width: 800px;
        margin: 2rem auto;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .form-header {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .form-container {
        padding: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #2c3e50;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      input:focus,
      textarea:focus {
        outline: none;
        border-color: #3498db;
      }

      textarea {
        resize: vertical;
        min-height: 100px;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .file-input-wrapper {
        border: 2px dashed #ddd;
        padding: 2rem;
        text-align: center;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
      }

      .file-input-wrapper:hover {
        border-color: #3498db;
        background: #f8f9fa;
      }

      .file-input-wrapper input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        top: 0;
        left: 0;
      }

      .file-input-content {
        pointer-events: none;
      }

      .submit-btn {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        transition: transform 0.3s;
      }

      .submit-btn:hover {
        transform: translateY(-2px);
      }

      .itinerary-item {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
        align-items: start;
      }

      .day-number {
        background: #3498db;
        color: white;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        flex-shrink: 0;
        margin-top: 0.5rem;
      }

      .add-day-btn {
        background: #95a5a6;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .container {
          margin: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="header">
      <a href="/tour/admin/dashboard" class="back-btn">
        <i class="fas fa-arrow-left"></i>
        Back to Dashboard
      </a>
      <div>Admin Panel</div>
    </div>

    <div class="container">
      <div class="form-header">
        <h1><i class="fas fa-plus-circle"></i> Create New Tour</h1>
        <p>Add a new exciting destination to your tour collection</p>
      </div>

      <div class="form-container">
        <% if (typeof error !== 'undefined' && error) { %>
        <div
          style="
            background: #e74c3c;
            color: white;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
          "
        >
          <%= error %>
        </div>
        <% } %>

        <!-- ✅ CRITICAL: Added enctype and method -->
        <form method="POST" action="/tour" enctype="multipart/form-data">
          <!-- Basic Info -->
          <div class="form-group">
            <label for="name">Tour Name *</label>
            <input
              type="text"
              id="name"
              name="name"
              required
              placeholder="e.g., Royal Rajasthan Heritage"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="location">Location *</label>
              <input
                type="text"
                id="location"
                name="location"
                required
                placeholder="e.g., Jaipur, Rajasthan"
              />
            </div>
            <div class="form-group">
              <label for="price">Price (₹) *</label>
              <input
                type="number"
                id="price"
                name="price"
                required
                placeholder="25000"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="duration">Duration *</label>
            <input
              type="text"
              id="duration"
              name="duration"
              required
              placeholder="e.g., 5 Days 4 Nights"
            />
          </div>

          <div class="form-group">
            <label for="overview">Tour Overview *</label>
            <textarea
              id="overview"
              name="overview"
              required
              placeholder="Describe what makes this tour special..."
            ></textarea>
          </div>

          <!-- Cover Image -->
          <div class="form-group">
            <label>Cover Image (Optional)</label>
            <div class="file-input-wrapper">
              <input type="file" name="coverImage" accept="image/*" />
              <div class="file-input-content">
                <i
                  class="fas fa-image fa-2x"
                  style="color: #bbb; margin-bottom: 0.5rem"
                ></i>
                <p>Click to select cover image</p>
                <p style="font-size: 0.8rem; color: #999">
                  JPG, PNG, GIF (Max 5MB)
                </p>
              </div>
            </div>
          </div>

          <!-- Gallery Images -->
          <div class="form-group">
            <label>Gallery Images (Optional)</label>
            <div class="file-input-wrapper">
              <input type="file" name="moreImages" accept="image/*" multiple />
              <div class="file-input-content">
                <i
                  class="fas fa-images fa-2x"
                  style="color: #bbb; margin-bottom: 0.5rem"
                ></i>
                <p>Select multiple gallery images (up to 8)</p>
                <p style="font-size: 0.8rem; color: #999">
                  Hold Ctrl/Cmd to select multiple
                </p>
              </div>
            </div>
          </div>

          <!-- Video -->
          <div class="form-group">
            <label for="video">YouTube Video URL (Optional)</label>
            <input
              type="url"
              id="video"
              name="video"
              placeholder="https://www.youtube.com/embed/..."
            />
          </div>

          <!-- Includes/Excludes -->
          <div class="form-row">
            <div class="form-group">
              <label for="included">Included Services</label>
              <textarea
                id="included"
                name="included"
                placeholder="Hotel accommodation&#10;Meals&#10;Transportation&#10;Tour guide"
              ></textarea>
            </div>
            <div class="form-group">
              <label for="excluded">Excluded Services</label>
              <textarea
                id="excluded"
                name="excluded"
                placeholder="Personal expenses&#10;Tips&#10;Travel insurance&#10;Flight tickets"
              ></textarea>
            </div>
          </div>

          <!-- Itinerary -->
          <div class="form-group">
            <label>Day by Day Itinerary (Optional)</label>
            <div id="itinerary-container">
              <div class="itinerary-item">
                <div class="day-number">1</div>
                <div style="flex: 1">
                  <input
                    type="text"
                    name="itinerary[0][title]"
                    placeholder="Day 1 - Arrival"
                    style="margin-bottom: 0.5rem"
                  />
                  <textarea
                    name="itinerary[0][description]"
                    placeholder="Arrival and check-in..."
                  ></textarea>
                </div>
              </div>
            </div>
            <button
              type="button"
              class="add-day-btn"
              onclick="addItineraryDay()"
            >
              + Add Another Day
            </button>
          </div>
          <!-- Available Dates Section -->
          <div class="form-group">
            <div class="dates-section">
              <div class="dates-header">
                <div>
                  <h3><i class="fas fa-calendar-alt"></i> Available Dates</h3>
                  <p class="date-count" id="dateCount">0 dates added</p>
                </div>
                <button
                  type="button"
                  class="add-date-btn"
                  onclick="addAvailableDate()"
                >
                  <i class="fas fa-plus"></i>
                  Add Date
                </button>
              </div>

              <div id="available-dates-container">
                <!-- Dates will be added here dynamically -->
              </div>

              <div class="dates-info">
                <i class="fas fa-info-circle"></i>
                <strong>Tip:</strong> Add multiple dates when this tour will be
                available for booking. Past dates will be automatically removed.
                You can always add more dates later from the admin dashboard.
              </div>
            </div>
          </div>

          <button type="submit" class="submit-btn">
            <i class="fas fa-save"></i>
            Create Tour
          </button>
        </form>
      </div>
    </div>

    <script>
      let dayCount = 1;
      let dateCount = 0;

      function addItineraryDay() {
        dayCount++;
        const container = document.getElementById("itinerary-container");
        const newDay = document.createElement("div");
        newDay.className = "itinerary-item";
        newDay.innerHTML = `
    <div class="day-number">${dayCount}</div>
    <div style="flex: 1;">
      <input type="text" name="itinerary[${
        dayCount - 1
      }][title]" placeholder="Day ${dayCount} - Title" style="margin-bottom: 0.5rem;">
      <textarea name="itinerary[${
        dayCount - 1
      }][description]" placeholder="Day ${dayCount} activities..."></textarea>
    </div>
  `;
        container.appendChild(newDay);
      }

      // Available Dates Functions
      function addAvailableDate() {
        dateCount++;
        const container = document.getElementById("available-dates-container");
        const dateItem = document.createElement("div");
        dateItem.className = "date-item";
        dateItem.id = `date-item-${dateCount}`;

        // Set minimum date to today
        const today = new Date().toISOString().split("T")[0];

        dateItem.innerHTML = `
    <input 
      type="date" 
      name="availableDates[]" 
      min="${today}"
      required
      onchange="validateDate(this)"
    />
    <button type="button" class="remove-date-btn" onclick="removeAvailableDate(${dateCount})">
      <i class="fas fa-trash"></i>
    </button>
  `;

        container.appendChild(dateItem);
        updateDateCount();
      }

      function removeAvailableDate(id) {
        const dateItem = document.getElementById(`date-item-${id}`);
        if (dateItem) {
          dateItem.remove();
          updateDateCount();
        }
      }

      function updateDateCount() {
        const activeDates = document.querySelectorAll(
          "#available-dates-container .date-item"
        ).length;
        document.getElementById(
          "dateCount"
        ).textContent = `${activeDates} dates added`;
      }

      function validateDate(input) {
        const selectedDate = new Date(input.value);
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
          alert("Please select a future date. Past dates are not allowed.");
          input.value = "";
          return false;
        }

        // Check for duplicate dates
        const allDates = document.querySelectorAll(
          'input[name="availableDates[]"]'
        );
        const currentValue = input.value;
        let duplicateCount = 0;

        allDates.forEach((dateInput) => {
          if (dateInput.value === currentValue) {
            duplicateCount++;
          }
        });

        if (duplicateCount > 1) {
          alert(
            "This date has already been selected. Please choose a different date."
          );
          input.value = "";
          return false;
        }

        return true;
      }

      // Add some initial dates for better UX
      document.addEventListener("DOMContentLoaded", function () {
        // Automatically add first date field
        addAvailableDate();
      });

      // File input feedback (existing code)
      document
        .querySelector('input[name="coverImage"]')
        .addEventListener("change", function () {
          const fileName = this.files[0]?.name;
          if (fileName) {
            const content = this.parentElement.querySelector(
              ".file-input-content"
            );
            content.innerHTML = `<i class="fas fa-check-circle" style="color: #27ae60; font-size: 2rem; margin-bottom: 0.5rem;"></i><p>Selected: ${fileName}</p>`;
          }
        });

      document
        .querySelector('input[name="moreImages"]')
        .addEventListener("change", function () {
          const fileCount = this.files.length;
          if (fileCount > 0) {
            const content = this.parentElement.querySelector(
              ".file-input-content"
            );
            content.innerHTML = `<i class="fas fa-check-circle" style="color: #27ae60; font-size: 2rem; margin-bottom: 0.5rem;"></i><p>Selected: ${fileCount} images</p>`;
          }
        });
    </script>
  </body>
</html>
